name: üöÄ Auto Project Board Sync

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, ready_for_review, closed, converted_to_draft]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

env:
  PROJECT_NAME: "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–æ–≤"
  USER_LOGIN: "virusneo1997-del"

jobs:
  sync-project:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: ü§ñ Sync Pull Request with Project Board
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');

            try {
              // === 1. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç –ø–æ –∏–º–µ–Ω–∏ ===
              const projectsQuery = `query($login: String!) {
                user(login: $login) {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      title
                      url
                    }
                  }
                }
              }`;

              const result = await github.graphql(projectsQuery, { login: process.env.USER_LOGIN });
              const projects = result.user.projectsV2.nodes;
              const project = projects.find(p => p.title === process.env.PROJECT_NAME);

              if (!project) {
                console.log(`‚ùå –ü—Ä–æ–µ–∫—Ç "${process.env.PROJECT_NAME}" –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
                console.log("üìã –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–µ–∫—Ç—ã:", projects.map(p => p.title));
                return;
              }

              console.log(`üéØ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: ${project.title}`);
              console.log(`üîó ${project.url}`);
              const projectId = project.id;

              // === 2. –î–∞–Ω–Ω—ã–µ PR ===
              const { pull_request } = context.payload;
              if (!pull_request) {
                console.log("‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ pull request");
                return;
              }

              const author = pull_request.user.login;
              const action = context.payload.action;
              const merged = pull_request.merged;
              const isDraft = pull_request.draft;
              console.log(`üë§ –ê–≤—Ç–æ—Ä: ${author}, –¥–µ–π—Å—Ç–≤–∏–µ: ${action}, merged=${merged}, draft=${isDraft}`);

              // === 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å ===
              let newStatus = null;
              switch (action) {
                case "opened":
                  newStatus = isDraft ? "To do" : "In Progress";
                  break;
                case "reopened":
                  newStatus = "To do";
                  break;
                case "ready_for_review":
                  newStatus = "In Review";
                  break;
                case "converted_to_draft":
                  newStatus = "To do";
                  break;
                case "closed":
                  newStatus = merged ? "Done" : "To do";
                  break;
                default:
                  console.log(`‚ÑπÔ∏è –ù–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${action}`);
                  return;
              }
              console.log(`üéØ –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${newStatus}`);

              // === 4. –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ ===
              const projectDetailsQuery = `query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                    items(first: 50) {
                      nodes {
                        id
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              field { ... on ProjectV2FieldCommon { name } }
                              text
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }`;

              const details = await github.graphql(projectDetailsQuery, { projectId });
              const fields = details.node.fields.nodes;
              const items = details.node.items.nodes;

              // === 5. –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ "Status" ===
              const statusField = fields.find(f => f.name === "Status" && f.options);
              if (!statusField) {
                console.log("‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
                console.log("–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:", fields.map(f => f.name));
                return;
              }

              const statusOption = statusField.options.find(o => o.name === newStatus);
              if (!statusOption) {
                console.log(`‚ùå –°—Ç–∞—Ç—É—Å "${newStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –æ–ø—Ü–∏–π –ø–æ–ª—è Status`);
                return;
              }

              // === 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ PR –≤ –ø—Ä–æ–µ–∫—Ç–µ ===
              let item = items.find(i => {
                const f = i.fieldValues.nodes.find(f => f.text === author);
                return f;
              });

              // === 7. –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç ===
              if (!item) {
                console.log(`üÜï –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é`);
                const createItem = await github.graphql(`
                  mutation($input: AddProjectV2ItemByIdInput!) {
                    addProjectV2ItemById(input: $input) {
                      item { id }
                    }
                  }`,
                  {
                    input: {
                      projectId: projectId,
                      contentId: pull_request.node_id
                    }
                  }
                );
                item = { id: createItem.addProjectV2ItemById.item.id };
                console.log(`‚úÖ –ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: ${item.id}`);
              } else {
                console.log(`üìé –ö–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${item.id}`);
              }

              // === 8. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å ===
              await github.graphql(`
                mutation($input: UpdateProjectV2ItemFieldValueInput!) {
                  updateProjectV2ItemFieldValue(input: $input) {
                    projectV2Item { id }
                  }
                }`,
                {
                  input: {
                    projectId: projectId,
                    itemId: item.id,
                    fieldId: statusField.id,
                    value: { singleSelectOptionId: statusOption.id }
                  }
                }
              );

              console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚Üí ${newStatus}`);
              console.log("=== üèÅ –ó–ê–í–ï–†–®–ï–ù–û ===");

            } catch (err) {
              console.error("üí• –û—à–∏–±–∫–∞:", err.message);
              if (err.errors) console.log(JSON.stringify(err.errors, null, 2));
            }
